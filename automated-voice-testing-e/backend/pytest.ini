# Pytest Configuration (TASK-140)
#
# This file configures pytest for the Voice AI Testing Framework backend.
# It defines test discovery patterns, markers for test organization,
# coverage settings, and additional pytest behavior.

[pytest]
# Test Discovery
# ===============
# Define where pytest should look for tests and how to identify them

# Directories to search for tests
testpaths = tests

# Filename patterns for test files (default: test_*.py or *_test.py)
python_files = test_*.py *_test.py

# Class name patterns for test classes (default: Test*)
python_classes = Test*

# Function name patterns for test functions (default: test_*)
python_functions = test_*


# Test Markers
# ============
# Register custom markers for categorizing tests
# Usage: @pytest.mark.marker_name

markers =
    unit: Unit tests that test individual components in isolation
    integration: Integration tests that test interactions between components
    e2e: End-to-end tests that test complete workflows
    slow: Tests that take a long time to run (> 1 second)
    asyncio: Tests that use async/await (auto-applied by pytest-asyncio)
    db: Tests that require database access
    redis: Tests that require Redis access
    celery: Tests that involve Celery tasks
    api: Tests that test API endpoints
    validation: Tests for validation logic
    audio: Tests involving audio processing
    tts: Tests for text-to-speech functionality
    soundhound: Tests for SoundHound integration
    storage: Tests for S3/MinIO storage


# Coverage Configuration
# ======================
# Configure pytest-cov plugin for code coverage reporting

addopts =
    # Verbose output
    -v

    # Show test durations
    --durations=10

    # Coverage options (configured in .coveragerc)
    --cov=.
    --cov-report=term-missing:skip-covered
    --cov-report=html
    --cov-report=xml
    --cov-branch

    # Strict markers (fail on unknown markers)
    --strict-markers

    # Show local variables in tracebacks
    -l

    # Capture output (use -s to disable)
    --capture=no

    # Show warnings
    -W default


# Asyncio Configuration
# ====================
# Configure pytest-asyncio plugin for async test support
# Using strict mode to avoid package-level fixture issues

asyncio_mode = strict
asyncio_default_fixture_loop_scope = function


# Warning Filters
# ===============
# Configure how warnings are displayed

filterwarnings =
    # Treat warnings as errors (strict mode)
    # error

    # Ignore specific deprecation warnings
    ignore::DeprecationWarning:dateutil.*

    # Ignore SQLAlchemy warnings
    ignore::sqlalchemy.exc.SAWarning


# Logging Configuration
# ====================
# Configure logging output during tests

# Show log output in console
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Log file configuration
log_file = pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(name)s - %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S


# Additional Options
# =================

# Minimum Python version
minversion = 3.10

# Test output settings
console_output_style = progress

# JUnit XML output for CI/CD
# Uncomment to generate JUnit XML report
# junit_family = xunit2
# junit_suite_name = Voice AI Testing Framework

# Timeout for tests (requires pytest-timeout plugin)
# timeout = 300
# timeout_method = thread


# Environment Variables
# ====================
# Set environment variables for tests
# env =
#     TESTING=true
#     DATABASE_URL=sqlite:///:memory:

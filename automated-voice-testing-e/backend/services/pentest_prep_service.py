"""
Penetration Testing Preparation Service for voice AI.

This service manages penetration testing preparation including
security architecture documentation, scope definition, and remediation workflows.

Key features:
- Document security architecture
- Prepare pen test scope
- Remediation workflow management

Example:
    >>> service = PentestPrepService()
    >>> result = service.define_scope(project_id, scope_data)
"""

from typing import List, Dict, Any, Optional
from datetime import datetime
import uuid


class PentestPrepService:
    """
    Service for penetration testing preparation.

    Provides security architecture documentation, scope definition,
    and remediation workflow management.

    Example:
        >>> service = PentestPrepService()
        >>> config = service.get_pentest_config()
    """

    def __init__(self):
        """Initialize the pentest prep service."""
        self._architecture_docs: Dict[str, Dict[str, Any]] = {}
        self._scope_documents: Dict[str, Dict[str, Any]] = {}
        self._remediation_tasks: List[Dict[str, Any]] = []

    def document_architecture(
        self,
        project_id: str,
        architecture_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Document security architecture for a project.

        Args:
            project_id: ID of project
            architecture_data: Architecture details

        Returns:
            Dictionary with documentation result

        Example:
            >>> result = service.document_architecture(proj_id, arch_data)
        """
        doc_id = str(uuid.uuid4())

        doc = {
            'doc_id': doc_id,
            'project_id': project_id,
            'components': architecture_data.get('components', []),
            'data_flows': architecture_data.get('data_flows', []),
            'trust_boundaries': architecture_data.get('trust_boundaries', []),
            'entry_points': architecture_data.get('entry_points', []),
            'created_at': datetime.utcnow().isoformat(),
            'version': 1
        }

        self._architecture_docs[project_id] = doc
        return doc

    def get_architecture_docs(
        self,
        project_id: str
    ) -> Dict[str, Any]:
        """
        Get architecture documentation for a project.

        Args:
            project_id: ID of project

        Returns:
            Dictionary with architecture documentation

        Example:
            >>> docs = service.get_architecture_docs(proj_id)
        """
        if project_id in self._architecture_docs:
            return self._architecture_docs[project_id]

        return {
            'project_id': project_id,
            'status': 'not_found',
            'error': f'No architecture docs for project {project_id}'
        }

    def define_scope(
        self,
        project_id: str,
        scope_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Define penetration test scope.

        Args:
            project_id: ID of project
            scope_data: Scope definition data

        Returns:
            Dictionary with scope document

        Example:
            >>> scope = service.define_scope(proj_id, scope_data)
        """
        scope_id = str(uuid.uuid4())

        scope = {
            'scope_id': scope_id,
            'project_id': project_id,
            'in_scope': scope_data.get('in_scope', []),
            'out_of_scope': scope_data.get('out_of_scope', []),
            'test_types': scope_data.get('test_types', []),
            'schedule': scope_data.get('schedule', {}),
            'rules_of_engagement': scope_data.get('rules_of_engagement', {}),
            'created_at': datetime.utcnow().isoformat(),
            'status': 'draft'
        }

        self._scope_documents[project_id] = scope
        return scope

    def get_scope_document(
        self,
        project_id: str
    ) -> Dict[str, Any]:
        """
        Get scope document for a project.

        Args:
            project_id: ID of project

        Returns:
            Dictionary with scope document

        Example:
            >>> scope = service.get_scope_document(proj_id)
        """
        if project_id in self._scope_documents:
            return self._scope_documents[project_id]

        return {
            'project_id': project_id,
            'status': 'not_found',
            'error': f'No scope document for project {project_id}'
        }

    def create_remediation_task(
        self,
        finding_id: str,
        task_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Create a remediation task for a finding.

        Args:
            finding_id: ID of security finding
            task_data: Task details

        Returns:
            Dictionary with task details

        Example:
            >>> task = service.create_remediation_task(finding_id, task_data)
        """
        task_id = str(uuid.uuid4())

        task = {
            'task_id': task_id,
            'finding_id': finding_id,
            'title': task_data.get('title', ''),
            'description': task_data.get('description', ''),
            'severity': task_data.get('severity', 'medium'),
            'assignee': task_data.get('assignee'),
            'due_date': task_data.get('due_date'),
            'status': 'open',
            'created_at': datetime.utcnow().isoformat(),
            'updated_at': datetime.utcnow().isoformat()
        }

        self._remediation_tasks.append(task)
        return task

    def get_remediation_tasks(
        self,
        finding_id: Optional[str] = None,
        status: Optional[str] = None
    ) -> List[Dict[str, Any]]:
        """
        Get remediation tasks with optional filters.

        Args:
            finding_id: Filter by finding ID
            status: Filter by status

        Returns:
            List of remediation tasks

        Example:
            >>> tasks = service.get_remediation_tasks(status='open')
        """
        tasks = self._remediation_tasks

        if finding_id:
            tasks = [t for t in tasks if t['finding_id'] == finding_id]

        if status:
            tasks = [t for t in tasks if t['status'] == status]

        return tasks

    def update_remediation_status(
        self,
        task_id: str,
        status: str,
        notes: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Update remediation task status.

        Args:
            task_id: ID of task
            status: New status
            notes: Optional status notes

        Returns:
            Dictionary with update result

        Example:
            >>> result = service.update_remediation_status(task_id, 'in_progress')
        """
        for task in self._remediation_tasks:
            if task['task_id'] == task_id:
                task['status'] = status
                task['updated_at'] = datetime.utcnow().isoformat()
                if notes:
                    if 'notes' not in task:
                        task['notes'] = []
                    task['notes'].append({
                        'text': notes,
                        'timestamp': datetime.utcnow().isoformat()
                    })
                return {
                    'success': True,
                    'task_id': task_id,
                    'status': status,
                    'updated_at': task['updated_at']
                }

        return {
            'success': False,
            'task_id': task_id,
            'error': f'Task {task_id} not found'
        }

    def get_pentest_config(self) -> Dict[str, Any]:
        """
        Get penetration testing configuration.

        Returns:
            Dictionary with configuration

        Example:
            >>> config = service.get_pentest_config()
        """
        return {
            'total_architecture_docs': len(self._architecture_docs),
            'total_scope_documents': len(self._scope_documents),
            'total_remediation_tasks': len(self._remediation_tasks),
            'test_types': [
                'network',
                'web_application',
                'api',
                'mobile',
                'social_engineering'
            ],
            'severity_levels': ['critical', 'high', 'medium', 'low', 'info'],
            'task_statuses': ['open', 'in_progress', 'resolved', 'verified', 'closed']
        }
